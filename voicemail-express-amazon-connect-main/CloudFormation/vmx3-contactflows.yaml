AWSTemplateFormatVersion: "2010-09-09"
Description: Deploys the Voicemail Express contact flows, as required.

Parameters:
  ConnectInstanceAlias:
    Type: String
  ConnectInstanceARN:
    Type: String
  VMTestAgentId:
    Type: String
  VMTestQueueARN:
    Type: String

Resources:
  VMXCoreFlowModule:
    Type: AWS::Connect::ContactFlowModule
    Properties:
      Content: "{\"Version\":\"2019-10-30\",\"StartAction\":\"Turn on flow logging.\",\"Metadata\":{\"entryPointPosition\":{\"x\":40,\"y\":40},\"ActionMetadata\":{\"Play the start recording beep using SSML\":{\"position\":{\"x\":1442.4,\"y\":39.2},\"isFriendlyName\":true},\"Clear vmx3_flag\":{\"position\":{\"x\":1440.8,\"y\":302.4},\"isFriendlyName\":true,\"dynamicParams\":[]},\"***Return to source flow***\":{\"position\":{\"x\":2162.4,\"y\":321.6},\"isFriendlyName\":true},\"Wait for caller to record.\":{\"position\":{\"x\":1678.4,\"y\":38.4},\"isFriendlyName\":true,\"conditionMetadata\":[]},\"Error messaging.\":{\"position\":{\"x\":1920.8,\"y\":299.2},\"isFriendlyName\":true},\"Stop KVS if the customer is still on the call.\":{\"position\":{\"x\":1920,\"y\":39.2},\"isFriendlyName\":true},\"***End Call***\":{\"position\":{\"x\":2381.6,\"y\":61.6},\"isFriendlyName\":true},\"Voicemail complete messaging.\":{\"position\":{\"x\":2159.2,\"y\":40.8},\"isFriendlyName\":true},\"Turn on flow logging.\":{\"position\":{\"x\":140.8,\"y\":40.8},\"isFriendlyName\":true},\"Start KVS from customer only\":{\"position\":{\"x\":940.8,\"y\":40.8},\"isFriendlyName\":true,\"toCustomer\":false,\"fromCustomer\":true},\"Set the vmx3_flag attribute for processing\":{\"position\":{\"x\":1201.6,\"y\":39.2},\"isFriendlyName\":true,\"dynamicParams\":[]},\"Was the vmx3_flag already set?\":{\"position\":{\"x\":1200,\"y\":300.8},\"isFriendlyName\":true,\"conditions\":[],\"conditionMetadata\":[{\"id\":\"2765ed29-4055-4884-9e93-cb955dbed0bb\",\"operator\":{\"name\":\"Is greater than\",\"value\":\"GreaterThan\",\"shortDisplay\":\">\"},\"value\":\"0\"}]},\"Play initial voicemail greeting\":{\"position\":{\"x\":420,\"y\":39.2},\"isFriendlyName\":true},\"KVS startup and flag loop\":{\"position\":{\"x\":675.2,\"y\":37.6},\"isFriendlyName\":true}},\"Annotations\":[{\"type\":\"default\",\"id\":\"9c8e7319-2cd9-4e3e-b018-003b3a7711c1\",\"content\":\"If you want to increase/decrease the amount of time for voicemail recordings, do that here via the Timeout setting in this block.\",\"actionId\":\"Wait for caller to record.\",\"isFolded\":true,\"position\":{\"x\":2117.1666666666665,\"y\":298.66666666666663},\"size\":{\"height\":295,\"width\":300}},{\"type\":\"default\",\"id\":\"9f79a94e-8842-4169-ac22-85f7e197cbc8\",\"content\":\"IMPORTANT\\n\\nONLY select the \\\"From the customer\\\" side of the conversation in this block. \\n\\nSelecting only the \\\"To the customer\\\" option will result in a blank message.\\n\\nSelecting both sides will result in garbled audio.\",\"actionId\":\"Start KVS from customer only\",\"isFolded\":true,\"position\":{\"x\":1195.1666666666667,\"y\":257.66666666666663},\"size\":{\"height\":295,\"width\":300}},{\"type\":\"default\",\"id\":\"8dd4f533-9cbc-438f-8d84-3496dc3f72b9\",\"content\":\"This is the core voicemail experience. This flow module handles the initialization of KVS for storing the audio, configuration of the minimum flag required to process the voicemail, and provides the customer experience. This module can be invoked from any normal contact flow.\\n\\nThe following attributes MUST have been defined previously:\\n\\nvmx3_mode\\nvmx3_from\\nvmx3_lang\\nvmx3_queue_arn\",\"actionId\":\"\",\"isFolded\":false,\"position\":{\"x\":174,\"y\":252},\"size\":{\"height\":295,\"width\":300}}]},\"Actions\":[{\"Parameters\":{\"SSML\":\"<speak>\\n  <say-as interpret-as=\\\"expletive\\\">beep</say-as>\\n</speak>\"},\"Identifier\":\"Play the start recording beep using SSML\",\"Type\":\"MessageParticipant\",\"Transitions\":{\"NextAction\":\"Wait for caller to record.\",\"Errors\":[{\"NextAction\":\"Wait for caller to record.\",\"ErrorType\":\"NoMatchingError\"}]}},{\"Parameters\":{\"Attributes\":{\"vmx3_flag\":\"0\"},\"TargetContact\":\"Current\"},\"Identifier\":\"Clear vmx3_flag\",\"Type\":\"UpdateContactAttributes\",\"Transitions\":{\"NextAction\":\"Error messaging.\",\"Errors\":[{\"NextAction\":\"Error messaging.\",\"ErrorType\":\"NoMatchingError\"}]}},{\"Parameters\":{},\"Identifier\":\"***Return to source flow***\",\"Type\":\"EndFlowModuleExecution\",\"Transitions\":{}},{\"Parameters\":{\"StoreInput\":\"False\",\"InputTimeLimitSeconds\":\"60\",\"SSML\":\"<speak>\\n<break time=\\\"5s\\\"/>\\n</speak>\"},\"Identifier\":\"Wait for caller to record.\",\"Type\":\"GetParticipantInput\",\"Transitions\":{\"NextAction\":\"Stop KVS if the customer is still on the call.\",\"Errors\":[{\"NextAction\":\"Stop KVS if the customer is still on the call.\",\"ErrorType\":\"InputTimeLimitExceeded\"},{\"NextAction\":\"Stop KVS if the customer is still on the call.\",\"ErrorType\":\"NoMatchingCondition\"},{\"NextAction\":\"Error messaging.\",\"ErrorType\":\"NoMatchingError\"}]}},{\"Parameters\":{\"Text\":\"The voicemail system has encountered an error. We are placing you in queue.\"},\"Identifier\":\"Error messaging.\",\"Type\":\"MessageParticipant\",\"Transitions\":{\"NextAction\":\"***Return to source flow***\",\"Errors\":[{\"NextAction\":\"***Return to source flow***\",\"ErrorType\":\"NoMatchingError\"}]}},{\"Parameters\":{\"MediaStreamingState\":\"Disabled\",\"Participants\":[{\"ParticipantType\":\"Customer\",\"MediaDirections\":[\"To\",\"From\"]}],\"MediaStreamType\":\"Audio\"},\"Identifier\":\"Stop KVS if the customer is still on the call.\",\"Type\":\"UpdateContactMediaStreamingBehavior\",\"Transitions\":{\"NextAction\":\"Voicemail complete messaging.\",\"Errors\":[{\"NextAction\":\"Voicemail complete messaging.\",\"ErrorType\":\"NoMatchingError\"}]}},{\"Parameters\":{},\"Identifier\":\"***End Call***\",\"Type\":\"DisconnectParticipant\",\"Transitions\":{}},{\"Parameters\":{\"Text\":\"Your voicemail has been saved. Goodbye.\"},\"Identifier\":\"Voicemail complete messaging.\",\"Type\":\"MessageParticipant\",\"Transitions\":{\"NextAction\":\"***End Call***\",\"Errors\":[{\"NextAction\":\"***End Call***\",\"ErrorType\":\"NoMatchingError\"}]}},{\"Parameters\":{\"FlowLoggingBehavior\":\"Enabled\"},\"Identifier\":\"Turn on flow logging.\",\"Type\":\"UpdateFlowLoggingBehavior\",\"Transitions\":{\"NextAction\":\"Play initial voicemail greeting\"}},{\"Parameters\":{\"MediaStreamingState\":\"Enabled\",\"MediaStreamType\":\"Audio\",\"Participants\":[{\"ParticipantType\":\"Customer\",\"MediaDirections\":[\"From\"]}]},\"Identifier\":\"Start KVS from customer only\",\"Type\":\"UpdateContactMediaStreamingBehavior\",\"Transitions\":{\"NextAction\":\"Set the vmx3_flag attribute for processing\",\"Errors\":[{\"NextAction\":\"KVS startup and flag loop\",\"ErrorType\":\"NoMatchingError\"}]}},{\"Parameters\":{\"Attributes\":{\"vmx3_flag\":\"1\"},\"TargetContact\":\"Current\"},\"Identifier\":\"Set the vmx3_flag attribute for processing\",\"Type\":\"UpdateContactAttributes\",\"Transitions\":{\"NextAction\":\"Play the start recording beep using SSML\",\"Errors\":[{\"NextAction\":\"KVS startup and flag loop\",\"ErrorType\":\"NoMatchingError\"}]}},{\"Parameters\":{\"ComparisonValue\":\"$.Attributes.vmx3_flag\"},\"Identifier\":\"Was the vmx3_flag already set?\",\"Type\":\"Compare\",\"Transitions\":{\"NextAction\":\"Error messaging.\",\"Conditions\":[{\"NextAction\":\"Clear vmx3_flag\",\"Condition\":{\"Operator\":\"NumberGreaterThan\",\"Operands\":[\"0\"]}}],\"Errors\":[{\"NextAction\":\"Error messaging.\",\"ErrorType\":\"NoMatchingCondition\"}]}},{\"Parameters\":{\"Text\":\"We will begin to record your message after the tone. When finished, you may hang up. Your voicemail will be saved and delivered to a representative.\"},\"Identifier\":\"Play initial voicemail greeting\",\"Type\":\"MessageParticipant\",\"Transitions\":{\"NextAction\":\"KVS startup and flag loop\",\"Errors\":[{\"NextAction\":\"KVS startup and flag loop\",\"ErrorType\":\"NoMatchingError\"}]}},{\"Parameters\":{\"LoopCount\":\"2\"},\"Identifier\":\"KVS startup and flag loop\",\"Type\":\"Loop\",\"Transitions\":{\"NextAction\":\"Was the vmx3_flag already set?\",\"Conditions\":[{\"NextAction\":\"Start KVS from customer only\",\"Condition\":{\"Operator\":\"Equals\",\"Operands\":[\"ContinueLooping\"]}},{\"NextAction\":\"Was the vmx3_flag already set?\",\"Condition\":{\"Operator\":\"Equals\",\"Operands\":[\"DoneLooping\"]}}]}}],\"Settings\":{\"InputParameters\":[],\"OutputParameters\":[],\"Transitions\":[]}}"
      Description: Core contact flow module that records the voicemail. Intended to be called from other contact flows. Please make sure that all required attributes for your voicemail delivery model are set prior to invoking this flow.
      InstanceArn:
        Ref: ConnectInstanceARN
      Name:
        !Join
          - ''
          - - 'VMX3-CoreFlowModule-'
            - !Ref ConnectInstanceAlias
      State: ACTIVE

  VMXExampleTaskFlow:
    Type: AWS::Connect::ContactFlow
    Properties:
      Content: "{\"Version\":\"2019-10-30\",\"StartAction\":\"Set the target queue\",\"Metadata\":{\"entryPointPosition\":{\"x\":20.8,\"y\":20},\"ActionMetadata\":{\"Set the target queue\":{\"position\":{\"x\":140,\"y\":17.6},\"isFriendlyName\":true,\"parameters\":{\"QueueId\":{\"useDynamic\":true}},\"useDynamic\":true},\"Route voicemail\":{\"position\":{\"x\":382.4,\"y\":18.4},\"isFriendlyName\":true},\"End flow\":{\"position\":{\"x\":620,\"y\":78.4},\"isFriendlyName\":true}},\"Annotations\":[]},\"Actions\":[{\"Parameters\":{\"QueueId\":\"$.Attributes.vmx3_queue_arn\"},\"Identifier\":\"Set the target queue\",\"Type\":\"UpdateContactTargetQueue\",\"Transitions\":{\"NextAction\":\"Route voicemail\",\"Errors\":[{\"NextAction\":\"Route voicemail\",\"ErrorType\":\"NoMatchingError\"}]}},{\"Parameters\":{},\"Identifier\":\"Route voicemail\",\"Type\":\"TransferContactToQueue\",\"Transitions\":{\"NextAction\":\"End flow\",\"Errors\":[{\"NextAction\":\"End flow\",\"ErrorType\":\"QueueAtCapacity\"},{\"NextAction\":\"End flow\",\"ErrorType\":\"NoMatchingError\"}]}},{\"Parameters\":{},\"Identifier\":\"End flow\",\"Type\":\"DisconnectParticipant\",\"Transitions\":{}}]}"
      Description: Sample basic task flow for voicemail.
      InstanceArn:
        Ref: ConnectInstanceARN
      Name:
        !Join
          - ''
          - - 'VMX3-BasicTaskFlow-'
            - !Ref ConnectInstanceAlias
      State: ACTIVE
      Type: CONTACT_FLOW

  VMXAWSTestFlow:
    Type: AWS::Connect::ContactFlow
    DependsOn:
        - VMXCoreFlowModule
        - VMXExampleTaskFlow
    Properties:
      Content: !Sub
        - "{\"Version\":\"2019-10-30\",\"StartAction\":\"Turn on flow logging\",\"Metadata\":{\"entryPointPosition\":{\"x\":-520,\"y\":-42.4},\"ActionMetadata\":{\"End Test\":{\"position\":{\"x\":220,\"y\":640.8},\"isFriendlyName\":true},\"Set agent queue\":{\"position\":{\"x\":-157.6,\"y\":192.8},\"isFriendlyName\":true,\"parameters\":{\"AgentId\":{\"useDynamic\":true}},\"useDynamic\":true},\"Set the destination type\":{\"position\":{\"x\":-400.8,\"y\":303.2},\"isFriendlyName\":true,\"conditionMetadata\":[{\"id\":\"344d5a2b-ca90-4654-bfd6-001213ade88c\",\"value\":\"1\"},{\"id\":\"9583d45c-a4a5-48d6-95aa-9a758202950d\",\"value\":\"2\"}]},\"Error message\":{\"position\":{\"x\":-4,\"y\":604.8},\"isFriendlyName\":true},\"Set standard queue\":{\"position\":{\"x\":134.4,\"y\":338.4},\"isFriendlyName\":true,\"parameters\":{\"QueueId\":{\"useDynamic\":true}},\"useDynamic\":true},\"Invoke the core VMX3 module\":{\"position\":{\"x\":902.4,\"y\":320.8},\"isFriendlyName\":true,\"parameters\":{\"FlowModuleId\":{\"useDynamic\":true}},\"useDynamic\":true},\"Initialization greeting\":{\"position\":{\"x\":379.2,\"y\":319.2},\"isFriendlyName\":true},\"Set required attributes for VMX3\":{\"position\":{\"x\":642.4,\"y\":321.6},\"isFriendlyName\":true,\"parameters\":{\"Attributes\":{\"vmx3_from\":{\"useDynamic\":true},\"vmx3_queue_arn\":{\"useDynamic\":true}}},\"dynamicParams\":[\"vmx3_from\",\"vmx3_queue_arn\"]},\"Turn on flow logging\":{\"position\":{\"x\":-398.4,\"y\":-39.2},\"isFriendlyName\":true},\"Main test flow greeting\":{\"position\":{\"x\":82.4,\"y\":-40.8},\"isFriendlyName\":true},\"Set all of the test attributes\":{\"position\":{\"x\":-160.8,\"y\":-41.6},\"isFriendlyName\":true,\"dynamicParams\":[]}},\"Annotations\":[]},\"Actions\":[{\"Parameters\":{},\"Identifier\":\"End Test\",\"Type\":\"DisconnectParticipant\",\"Transitions\":{}},{\"Parameters\":{\"AgentId\":\"$.Attributes.vmx3_test_agent\"},\"Identifier\":\"Set agent queue\",\"Type\":\"UpdateContactTargetQueue\",\"Transitions\":{\"NextAction\":\"Initialization greeting\",\"Errors\":[{\"NextAction\":\"Error message\",\"ErrorType\":\"NoMatchingError\"}]}},{\"Parameters\":{\"StoreInput\":\"False\",\"InputTimeLimitSeconds\":\"5\",\"Text\":\"Press 1 to test delivery of voicemail to an agent's personal queue. Press 2 to test delivery to a standard queue.\"},\"Identifier\":\"Set the destination type\",\"Type\":\"GetParticipantInput\",\"Transitions\":{\"NextAction\":\"Error message\",\"Conditions\":[{\"NextAction\":\"Set agent queue\",\"Condition\":{\"Operator\":\"Equals\",\"Operands\":[\"1\"]}},{\"NextAction\":\"Set standard queue\",\"Condition\":{\"Operator\":\"Equals\",\"Operands\":[\"2\"]}}],\"Errors\":[{\"NextAction\":\"Error message\",\"ErrorType\":\"InputTimeLimitExceeded\"},{\"NextAction\":\"Error message\",\"ErrorType\":\"NoMatchingCondition\"},{\"NextAction\":\"Error message\",\"ErrorType\":\"NoMatchingError\"}]}},{\"Parameters\":{\"Text\":\"We have encountered a system error. Please check flow logs to determine the issue.\"},\"Identifier\":\"Error message\",\"Type\":\"MessageParticipant\",\"Transitions\":{\"NextAction\":\"End Test\",\"Errors\":[{\"NextAction\":\"End Test\",\"ErrorType\":\"NoMatchingError\"}]}},{\"Parameters\":{\"QueueId\":\"$.Attributes.vmx3_test_queue\"},\"Identifier\":\"Set standard queue\",\"Type\":\"UpdateContactTargetQueue\",\"Transitions\":{\"NextAction\":\"Initialization greeting\",\"Errors\":[{\"NextAction\":\"Error message\",\"ErrorType\":\"NoMatchingError\"}]}},{\"Parameters\":{\"FlowModuleId\":\"$.Attributes.vmx3_core_module\"},\"Identifier\":\"Invoke the core VMX3 module\",\"Type\":\"InvokeFlowModule\",\"Transitions\":{\"NextAction\":\"Error message\",\"Errors\":[{\"NextAction\":\"Error message\",\"ErrorType\":\"NoMatchingError\"}]}},{\"Parameters\":{\"Text\":\"Connecting to the voicemail flow.\"},\"Identifier\":\"Initialization greeting\",\"Type\":\"MessageParticipant\",\"Transitions\":{\"NextAction\":\"Set required attributes for VMX3\",\"Errors\":[{\"NextAction\":\"Set required attributes for VMX3\",\"ErrorType\":\"NoMatchingError\"}]}},{\"Parameters\":{\"Attributes\":{\"vmx3_from\":\"$.CustomerEndpoint.Address\",\"vmx3_lang\":\"en-US\",\"vmx3_queue_arn\":\"$.Queue.ARN\",\"vmx3_mode\":\"task\"},\"TargetContact\":\"Current\"},\"Identifier\":\"Set required attributes for VMX3\",\"Type\":\"UpdateContactAttributes\",\"Transitions\":{\"NextAction\":\"Invoke the core VMX3 module\",\"Errors\":[{\"NextAction\":\"Invoke the core VMX3 module\",\"ErrorType\":\"NoMatchingError\"}]}},{\"Parameters\":{\"FlowLoggingBehavior\":\"Enabled\"},\"Identifier\":\"Turn on flow logging\",\"Type\":\"UpdateFlowLoggingBehavior\",\"Transitions\":{\"NextAction\":\"Set all of the test attributes\"}},{\"Parameters\":{\"Text\":\"This is the voicemail express test flow. This flow allows you to quickly validate the deployment. Voicemail will be delivered as an Amazon Connect task.\"},\"Identifier\":\"Main test flow greeting\",\"Type\":\"MessageParticipant\",\"Transitions\":{\"NextAction\":\"Set the destination type\",\"Errors\":[{\"NextAction\":\"Set the destination type\",\"ErrorType\":\"NoMatchingError\"}]}},{\"Parameters\":{\"Attributes\":{\"vmx3_core_module\":\"${VMCOREFLOWMODULE}\",\"vmx3_task_flow\":\"${VMTASKFLOW}\",\"vmx3_test_agent\":\"${VMTESTAGENTID}\",\"vmx3_test_queue\":\"${VMTESTQUEUENAME}\"},\"TargetContact\":\"Current\"},\"Identifier\":\"Set all of the test attributes\",\"Type\":\"UpdateContactAttributes\",\"Transitions\":{\"NextAction\":\"Main test flow greeting\",\"Errors\":[{\"NextAction\":\"Main test flow greeting\",\"ErrorType\":\"NoMatchingError\"}]}}]}"
        - VMTESTAGENTID: !Ref VMTestAgentId
          VMTESTQUEUENAME: !Ref VMTestQueueARN
          VMTASKFLOW: !Select [1, !Split ["contact-flow/", !Ref VMXExampleTaskFlow]]
          VMCOREFLOWMODULE: !Select [1, !Split ["flow-module/", !Ref VMXCoreFlowModule]]
      Description: Basic test flow to validate the Voicemail Express Deployment
      InstanceArn:
        Ref: ConnectInstanceARN
      Name:
        !Join
          - ''
          - - 'VMX3-AWSTestFlow-'
            - !Ref ConnectInstanceAlias
      State: ACTIVE
      Type: CONTACT_FLOW

Outputs:
    VMXExampleTaskFlowID:
      Description: ID of the tasks sample contact flow
      Value: !Select [1, !Split ["contact-flow/", !Ref VMXExampleTaskFlow]]
